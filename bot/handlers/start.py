# bot/handlers/start.py
"""ะะฑัะฐะฑะพััะธะบะธ ะฑะฐะทะพะฒัั ะบะพะผะฐะฝะด: /start, /help"""

from aiogram import Router, F
from aiogram.filters import Command, CommandStart
from aiogram.types import Message
import logging

from core.db_manager import get_db_manager

logger = logging.getLogger(__name__)

# ะกะพะทะดะฐะตะผ router ะดะปั ััะพะณะพ ะผะพะดัะปั
router = Router()


@router.message(CommandStart())
async def cmd_start(message: Message):
    """
    ะะฑัะฐะฑะพััะธะบ ะบะพะผะฐะฝะดั /start
    ะัะธะฒะตัััะฒะธะต ะธ ะบัะฐัะบะพะต ะพะฟะธัะฐะฝะธะต ะฒะพะทะผะพะถะฝะพััะตะน
    """
    user_id = message.from_user.id
    logger.info(f"User {user_id} started the bot")

    # ะัะพะฒะตัะธัั, ะฝะฐัััะพะตะฝ ะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั
    db = get_db_manager()
    user = await db.get_user(user_id)

    # ะัะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะต ะฝะฐัััะพะตะฝ, ะฝะฐะฟัะฐะฒะธัั ะฝะฐ /setup
    if not user or not user.is_configured:
        await message.answer(
            "๐ <b>ะะพะฑัะพ ะฟะพะถะฐะปะพะฒะฐัั ะฒ Telegram Analyzer Bot!</b>\n\n"
            "ะฏ ะฟะพะผะพะณั ัะบัะฟะพััะธัะพะฒะฐัั ะฒะฐัะธ Telegram ัะฐัั ะฒ CSV ัะพัะผะฐั "
            "ะธ ะฐะฝะฐะปะธะทะธัะพะฒะฐัั ะธั ัะตัะตะท Claude API.\n\n"
            "<b>๐ ะะพะทะผะพะถะฝะพััะธ:</b>\n"
            "โข ะญะบัะฟะพัั ะธััะพัะธะธ ัะพะพะฑัะตะฝะธะน ะธะท ะปัะฑะพะณะพ ัะฐัะฐ\n"
            "โข ะะฝะฐะปะธะท ัะฐัะพะฒ ัะตัะตะท Claude API (Sonnet 4)\n"
            "โข ะะพะดะดะตัะถะบะฐ ะบะฐะฝะฐะปะพะฒ, ะณััะฟะฟ ะธ ะปะธัะฝัั ัะฐัะพะฒ\n"
            "โข ะัะธะฝััะพะฝะฝะฐั ะพะฑัะฐะฑะพัะบะฐ (ะฝะต ะฑะปะพะบะธััะตั ะฑะพัะฐ)\n"
            "โข ะัััััะน ัะบัะฟะพัั ัะตัะตะท MTProto API\n\n"
            "โโโโโโโโโโโโโโโโโโโโโโ\n\n"
            "โ๏ธ <b>ะะตัะตะด ะฝะฐัะฐะปะพะผ ัะฐะฑะพัั ะฝะตะพะฑัะพะดะธะผะฐ ะฝะฐัััะพะนะบะฐ</b>\n\n"
            "ะะปั ัะฐะฑะพัั ะฑะพัะฐ ััะตะฑััััั:\n"
            "โข Telegram API ะบะปััะธ (API_ID, API_HASH)\n"
            "โข ะะฒัะพัะธะทะฐัะธั ะฒะฐัะตะณะพ ะฐะบะบะฐัะฝัะฐ\n"
            "โข Claude API ะบะปัั (ะพะฟัะธะพะฝะฐะปัะฝะพ, ะดะปั ะฐะฝะฐะปะธะทะฐ)\n\n"
            "ะะฐะถะผะธัะต /setup ะดะปั ะฝะฐัะฐะปะฐ ะฝะฐัััะพะนะบะธ!"
        )
        return

    # ะะพะปัะทะพะฒะฐัะตะปั ะฝะฐัััะพะตะฝ - ะฟะพะบะฐะทะฐัั ะณะปะฐะฒะฝะพะต ะผะตะฝั
    await message.answer(
        "๐ฏ <b>Telegram Analyzer Bot</b>\n\n"
        f"ะัะธะฒะตั, {message.from_user.first_name}! ะั ะฝะฐัััะพะตะฝั ะธ ะณะพัะพะฒั ะบ ัะฐะฑะพัะต.\n\n"
        "<b>๐ ะะพัััะฟะฝัะต ะบะพะผะฐะฝะดั:</b>\n\n"
        "<b>ะญะบัะฟะพัั:</b>\n"
        "/export @channel - ะญะบัะฟะพัั ัะฐัะฐ ะฒ CSV\n\n"
        "<b>ะะฝะฐะปะธะท:</b>\n"
        "/analyze ัะฐะนะป.csv - ะะฝะฐะปะธะท ัะตัะตะท Claude API\n\n"
        "<b>ะะพะผะฑะพ:</b>\n"
        "/exportanalyze @channel - ะญะบัะฟะพัั + ะฐะฝะฐะปะธะท\n\n"
        "<b>ะัะพัะตะต:</b>\n"
        "/setup - ะะตัะตะฝะฐัััะพะธัั ะฑะพัะฐ\n"
        "/help - ะะพะดัะพะฑะฝะฐั ัะฟัะฐะฒะบะฐ\n\n"
        "โโโโโโโโโโโโโโโโโโโโโโ\n\n"
        f"<b>ะะฐั ััะฐััั:</b>\n"
        f"โข Telegram API: {'โ' if user.is_authorized else 'โ'}\n"
        f"โข Claude API: {'โ' if user.claude_api_key else 'โ'}\n\n"
        "ะัะฟะพะปัะทัะนัะต /help ะดะปั ะฟะพะดัะพะฑะฝัั ะธะฝััััะบัะธะน."
    )


@router.message(Command("help"))
async def cmd_help(message: Message):
    """
    ะะฑัะฐะฑะพััะธะบ ะบะพะผะฐะฝะดั /help
    ะะพะดัะพะฑะฝะฐั ัะฟัะฐะฒะบะฐ ะฟะพ ะธัะฟะพะปัะทะพะฒะฐะฝะธั
    """
    logger.info(f"User {message.from_user.id} requested help")

    help_text = """
<b>๐ ะะพะดัะพะฑะฝะฐั ัะฟัะฐะฒะบะฐ</b>

โโโโโโโโโโโโโโโโโโโโโโ

<b>โ๏ธ ะะะะะะะ /setup</b>

ะะฐัััะพะนะบะฐ ะฑะพัะฐ ะดะปั ัะฐะฑะพัั

<b>ะงัะพ ะฝะฐัััะฐะธะฒะฐะตััั:</b>
โข Telegram API ะบะปััะธ (API_ID, API_HASH)
โข ะะฒัะพัะธะทะฐัะธั ะฒะฐัะตะณะพ ะฐะบะบะฐัะฝัะฐ
โข Claude API ะบะปัั (ะพะฟัะธะพะฝะฐะปัะฝะพ)

<b>ะะฐะบ ะฟะพะปััะธัั API ะบะปััะธ:</b>
1. ะะตัะตะนะดะธัะต: https://my.telegram.org
2. ะะพะนะดะธัะต ะฟะพะด ัะฒะพะธะผ ะฝะพะผะตัะพะผ
3. API development tools โ Create application
4. ะกะบะพะฟะธััะนัะต API ID ะธ API Hash

<b>ะะพะณะดะฐ ะฝัะถะฝะพ:</b>
โข ะัะธ ะฟะตัะฒะพะผ ะทะฐะฟััะบะต ะฑะพัะฐ
โข ะัะปะธ ะธััะตะบะปะฐ ัะตััะธั Telegram
โข ะะปั ัะผะตะฝั API ะบะปััะตะน

โโโโโโโโโโโโโโโโโโโโโโ

<b>๐ ะะะะะะะ /export</b>

ะญะบัะฟะพััะธััะตั ัะฐั ะฒ CSV ัะฐะนะป

<b>ะคะพัะผะฐั:</b>
<code>/export CHAT_ID</code>

<b>ะะดะต CHAT_ID:</b>
โข ะงะธัะปะพะฒะพะน ID: <code>-1001234567890</code>
โข Username: <code>@channelname</code>
โข ะกััะปะบะฐ: <code>https://t.me/channelname</code>

<b>ะัะธะผะตัั:</b>
<code>/export -1001234567890</code>
<code>/export @durov</code>

โโโโโโโโโโโโโโโโโโโโโโ

<b>๐ค ะะะะะะะ /analyze</b>

ะะฝะฐะปะธะทะธััะตั CSV ัะฐะนะป ัะตัะตะท Claude API

<b>ะคะพัะผะฐั 1:</b> ะัะธะบัะตะฟะธัะต CSV ัะฐะนะป ะบ ะบะพะผะฐะฝะดะต
<code>/analyze</code> (+ ัะฐะนะป)

<b>ะคะพัะผะฐั 2:</b> ะฃะบะฐะถะธัะต ะธะผั ัะฐะนะปะฐ
<code>/analyze ะธะผั_ัะฐะนะปะฐ.csv</code>

<b>ะงัะพ ะดะตะปะฐะตั:</b>
โข ะะฝะฐะปะธะทะธััะตั ัะพะพะฑัะตะฝะธั ัะตัะตะท Claude Sonnet 4
โข ะััะฒะปัะตั ัะฐัััะต ะทะฐะฟัะพัั ะบะปะธะตะฝัะพะฒ
โข ะะฐัะพะดะธั ะฟัะธัะธะฝั ะบะพะฝัะปะธะบัะพะฒ
โข ะกัะธัะฐะตั ััะฐัะธััะธะบั ะฟะพ ะผะตะฝะตะดะถะตัะฐะผ
โข ะะฝะฐะปะธะทะธััะตั ะฒัะตะผั ะพัะฒะตัะฐ

<b>ะะตะทัะปััะฐั:</b> DOCX ัะฐะนะป ั ะฟะพะดัะพะฑะฝัะผ ะฐะฝะฐะปะธะทะพะผ

โโโโโโโโโโโโโโโโโโโโโโ

<b>โก ะะะะะะะ /exportanalyze</b>

ะญะบัะฟะพัั + ะฐะฝะฐะปะธะท ะพะดะฝะพะน ะบะพะผะฐะฝะดะพะน

<b>ะคะพัะผะฐั:</b>
<code>/exportanalyze CHAT_ID</code>

<b>ะัะธะผะตัั:</b>
<code>/exportanalyze @support_chat</code>
<code>/exportanalyze -1001234567890</code>

<b>ะงัะพ ะดะตะปะฐะตั:</b>
1. ะญะบัะฟะพััะธััะตั ัะฐั ะฒ CSV (~30 ัะตะบ)
2. ะะฝะฐะปะธะทะธััะตั ัะตัะตะท Claude API (~1-3 ะผะธะฝ)
3. ะัะฟัะฐะฒะปัะตั ะพะฑะฐ ัะฐะนะปะฐ (CSV + DOCX)

โโโโโโโโโโโโโโโโโโโโโโ

<b>๐ ะะฐะบ ะฝะฐะนัะธ Chat ID:</b>

<b>ะะตัะพะด 1:</b> @userinfobot
ะะตัะตัะปะธัะต ัะพะพะฑัะตะฝะธะต ะธะท ัะฐัะฐ ะฑะพัั

<b>ะะตัะพะด 2:</b> ะะตะฑ-ะฒะตััะธั
https://web.telegram.org โ ะพัะบัะพะนัะต ัะฐั โ ID ะฒ URL

<b>ะะตัะพะด 3:</b> ะัะฑะปะธัะฝัะต ะบะฐะฝะฐะปั
ะัะฟะพะปัะทัะนัะต @username ะธะปะธ t.me ัััะปะบั

โโโโโโโโโโโโโโโโโโโโโโ

<b>โ๏ธ ะัะพะฑะตะฝะฝะพััะธ:</b>

<b>ะัะธะฝััะพะฝะฝะฐั ะพะฑัะฐะฑะพัะบะฐ:</b>
โข ะะพั ะพัะฒะตัะฐะตั ะผะณะฝะพะฒะตะฝะฝะพ
โข ะะฐะดะฐัะธ ะฒัะฟะพะปะฝััััั ะฒ ัะพะฝะต
โข ะฃะฒะตะดะพะผะปะตะฝะธั ะพ ะทะฐะฒะตััะตะฝะธะธ
โข ะะพะถะฝะพ ะทะฐะฟััะบะฐัั ะฝะตัะบะพะปัะบะพ ะทะฐะดะฐั

<b>ะขัะตะฑะพะฒะฐะฝะธั:</b>
โ ะั ะดะพะปะถะฝั ะฑััั ััะฐััะฝะธะบะพะผ ัะฐัะฐ
โ ะะฐัััะพะตะฝั Telegram API ะบะปััะธ (/setup)
โ ะะปั ะฐะฝะฐะปะธะทะฐ ะฝัะถะตะฝ Claude API ะบะปัั (/setup)

โโโโโโโโโโโโโโโโโโโโโโ

<b>๐ฌ ะัะต ะบะพะผะฐะฝะดั:</b>

/start - ะะปะฐะฒะฝะพะต ะผะตะฝั
/setup - ะะฐัััะพะนะบะฐ ะฑะพัะฐ
/export - ะญะบัะฟะพัั ัะฐัะฐ
/analyze - ะะฝะฐะปะธะท ัะตัะตะท Claude
/exportanalyze - ะญะบัะฟะพัั + ะฐะฝะฐะปะธะท
/help - ะญัะฐ ัะฟัะฐะฒะบะฐ

โโโโโโโโโโโโโโโโโโโโโโ

<b>๐ ะัััััะน ะฟัะธะผะตั:</b>

<code>/exportanalyze @my_support_chat</code>

ะงะตัะตะท ะฝะตัะบะพะปัะบะพ ะผะธะฝัั ะฟะพะปััะธัะต:
โข CSV ั ะธััะพัะธะตะน ัะพะพะฑัะตะฝะธะน
โข DOCX ั ะฐะฝะฐะปะธะทะพะผ ะพั Claude
"""

    await message.answer(help_text)
