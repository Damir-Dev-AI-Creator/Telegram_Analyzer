# üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –°–ò–°–¢–ï–ú–´ REAL-TIME –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê –ò –ê–ù–ê–õ–ò–ó–ê TELEGRAM

## üìã –°–û–î–ï–†–ñ–ê–ù–ò–ï
1. [–ö–æ–Ω—Ü–µ–ø—Ü–∏—è –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è](#–∫–æ–Ω—Ü–µ–ø—Ü–∏—è-–∏-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
2. [–í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](#–≤–∞—Ä–∏–∞–Ω—Ç—ã-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
3. [–í—ã–±—Ä–∞–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–≤—ã–±—Ä–∞–Ω–Ω–∞—è-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
4. [–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫](#—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π-—Å—Ç–µ–∫)
5. [–î–µ—Ç–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤](#–¥–µ—Ç–∞–ª—å–Ω—ã–π-–¥–∏–∑–∞–π–Ω-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤)
6. [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Å—Ö–µ–º–∞](#–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö-–∏-—Å—Ö–µ–º–∞)
7. [–ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö](#–∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è-–¥–∞–Ω–Ω—ã—Ö)
8. [–ü–ª–∞–Ω —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–∞ Debian VPS](#–ø–ª–∞–Ω-—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è)
9. [–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è](#–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ)
10. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
11. [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ observability](#–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)

---

## üìù –ö–û–ù–¶–ï–ü–¶–ò–Ø –ò –¢–†–ï–ë–û–í–ê–ù–ò–Ø

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (v1.0 - Batch Processing)
- ‚úÖ –†—É—á–Ω–æ–π —ç–∫—Å–ø–æ—Ä—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Telegram –≤ CSV
- ‚úÖ –ü–∞–∫–µ—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ CSV —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ Claude API
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è DOCX –æ—Ç—á–µ—Ç–æ–≤
- ‚ùå –ù–µ—Ç real-time –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- ‚ùå –ù–µ—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- ‚ùå –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏

### –¶–µ–ª–µ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (v2.0 - Real-Time System)

#### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
1. **Real-time –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
2. **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ** - PostgreSQL –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
3. **–ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ/—Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
4. **Userbot** - –æ–±—ã—á–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç Telegram (–Ω–µ –±–æ—Ç), –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π –≤–æ –≤—Å–µ —á–∞—Ç—ã
5. **–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç-–±–æ—Ç** - AI –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏
6. **VPS —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ** - —Ä–∞–±–æ—Ç–∞ 24/7 –Ω–∞ Debian —Å–µ—Ä–≤–µ—Ä–µ
7. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —á–∞—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

#### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–±–æ–µ–≤ (crash recovery)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∞–ª–µ—Ä—Ç—ã
- API –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
- Web dashboard –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

---

## üîÄ –í–ê–†–ò–ê–ù–¢–´ –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### –í–∞—Ä–∏–∞–Ω—Ç 1: UserBot + WebSocket + Real-time Processing

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
```
Telegram Chats ‚Üí UserBot (Telethon) ‚Üí WebSocket ‚Üí Real-time Processor ‚Üí PostgreSQL
                                                           ‚Üì
                                                    Claude API
                                                           ‚Üì
                                                   AI Assistant Bot
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –ù–∞—Å—Ç–æ—è—â–∏–π real-time (–º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã –∑–∞–¥–µ—Ä–∂–∫–∏)
- ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –í—ã—Å–æ–∫–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ Claude API (–∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
- ‚ùå –ù–µ—Ç –±–∞—Ç—á–∏–Ω–≥–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- ‚ùå –°–ª–æ–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø–∏–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏

**–°—Ç–æ–∏–º–æ—Å—Ç—å:** ~$500-1000/–º–µ—Å—è—Ü –ø—Ä–∏ 1000 —Å–æ–æ–±—â–µ–Ω–∏–π/–¥–µ–Ω—å

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: UserBot + Message Queue + Batch Processing

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
```
Telegram Chats ‚Üí UserBot ‚Üí RabbitMQ/Redis ‚Üí Batch Processor (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω) ‚Üí PostgreSQL
                                                      ‚Üì
                                               Claude API (batch)
                                                      ‚Üì
                                              AI Assistant Bot
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞—Ç—Ä–∞—Ç (–±–∞—Ç—á–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–æ–≤)
- ‚úÖ –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –ø–∏–∫–∞–º (–æ—á–µ—Ä–µ–¥—å —Å–≥–ª–∞–∂–∏–≤–∞–µ—Ç)
- ‚úÖ –ú–æ–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—Ñ–ª–∞–π–Ω

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –ó–∞–¥–µ—Ä–∂–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (5-15 –º–∏–Ω—É—Ç)
- ‚ùå –ë–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- ‚ùå –ù—É–∂–µ–Ω –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (–æ—á–µ—Ä–µ–¥—å)

**–°—Ç–æ–∏–º–æ—Å—Ç—å:** ~$100-300/–º–µ—Å—è—Ü –ø—Ä–∏ 1000 —Å–æ–æ–±—â–µ–Ω–∏–π/–¥–µ–Ω—å

---

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π)

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
```
Telegram Chats ‚Üí UserBot (Telethon)
                     ‚Üì
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚Üì                          ‚Üì
    Fast Lane                  Slow Lane
    (priority)                  (batch)
         ‚Üì                          ‚Üì
    Immediate                 Message Queue
    Processing                  (Redis)
         ‚Üì                          ‚Üì
    Claude API                Batch Processor
         ‚Üì                      (5-15 min)
         ‚Üì                          ‚Üì
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
              PostgreSQL
                    ‚Üì
           AI Assistant Bot
```

**–õ–æ–≥–∏–∫–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è:**
- **Fast Lane**: –°—Ä–æ—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç VIP –∫–ª–∏–µ–Ω—Ç–æ–≤, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ —Å–ª–æ–≤–∞ ("urgent", "bug", "–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç")
- **Slow Lane**: –û–±—ã—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –≤–æ–ø—Ä–æ—Å—ã, –æ–±—â–µ–Ω–∏–µ

**–ü–ª—é—Å—ã:**
- ‚úÖ –ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Å–∫–æ—Ä–æ—Å—Ç—å—é –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å—é
- ‚úÖ –ì–∏–±–∫–æ—Å—Ç—å –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞—Ç—Ä–∞—Ç
- ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –≤–∞–∂–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –°–∞–º–∞—è —Å–ª–æ–∂–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- ‚ùå –¢—Ä–µ–±—É–µ—Ç —Ç–æ–Ω–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∞–≤–∏–ª

**–°—Ç–æ–∏–º–æ—Å—Ç—å:** ~$150-400/–º–µ—Å—è—Ü –ø—Ä–∏ 1000 —Å–æ–æ–±—â–µ–Ω–∏–π/–¥–µ–Ω—å

---

## ‚úÖ –í–´–ë–†–ê–ù–ù–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê: –í–∞—Ä–∏–∞–Ω—Ç 3 (–ì–∏–±—Ä–∏–¥–Ω—ã–π)

### –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞
1. **–û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ü–µ–Ω–∞/—Å–∫–æ—Ä–æ—Å—Ç—å** - —Å—Ä–æ—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –±–∞—Ç—á–∞–º–∏
2. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –º–æ–∂–Ω–æ –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –≤–æ—Ä–∫–µ—Ä—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
3. **–ì–∏–±–∫–æ—Å—Ç—å** - –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞
4. **Fault tolerance** - –æ—á–µ—Ä–µ–¥—å –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å

---

## üõ†Ô∏è –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –°–¢–ï–ö

### Backend
- **Python 3.12+** - –æ—Å–Ω–æ–≤–Ω–æ–π —è–∑—ã–∫
- **Telethon** - UserBot –¥–ª—è Telegram
- **PostgreSQL 16** - –æ—Å–Ω–æ–≤–Ω–∞—è –ë–î
- **Redis 7** - –æ—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π + –∫—ç—à
- **FastAPI** - REST API + WebSocket
- **SQLAlchemy 2.0** - ORM
- **Alembic** - –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
- **Celery** - —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á

### AI & Analytics
- **Claude API (Anthropic)** - –∞–Ω–∞–ª–∏–∑ –∏ –æ—Ç–≤–µ—Ç—ã
- **LangChain** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞–º–∏ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- **Sentence Transformers** - –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞
- **pgvector** - –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –≤ PostgreSQL

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- **Prometheus** - –º–µ—Ç—Ä–∏–∫–∏
- **Grafana** - –¥–∞—à–±–æ—Ä–¥—ã
- **Loki** - –ª–æ–≥–∏
- **AlertManager** - –∞–ª–µ—Ä—Ç—ã

### DevOps
- **Docker & Docker Compose** - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è
- **Nginx** - reverse proxy
- **Systemd** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞–º–∏
- **Let's Encrypt** - SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã

---

## üîß –î–ï–¢–ê–õ–¨–ù–´–ô –î–ò–ó–ê–ô–ù –ö–û–ú–ü–û–ù–ï–ù–¢–û–í

### 1. UserBot Service (Telegram Listener)

```python
# services/userbot_monitor.py
"""
Real-time –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Telegram —á–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ UserBot.
–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –≤ Fast/Slow Lane.
"""

from telethon import TelegramClient, events
from typing import Optional
import asyncio

class TelegramUserBot:
    """UserBot –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —á–∞—Ç–æ–≤"""

    def __init__(self, api_id, api_hash, phone, session_path):
        self.client = TelegramClient(session_path, api_id, api_hash)
        self.monitored_chats = []

    async def start(self):
        """–ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞"""
        await self.client.start(phone=self.phone)

        # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        @self.client.on(events.NewMessage)
        async def handle_new_message(event):
            await self.process_message(event)

    async def process_message(self, event):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        message_data = {
            'chat_id': event.chat_id,
            'message_id': event.id,
            'user_id': event.sender_id,
            'text': event.text,
            'timestamp': event.date,
            'reply_to': event.reply_to_msg_id
        }

        # –ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è
        message_data = anonymize_message(message_data)

        # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
        priority = determine_priority(message_data)

        if priority == 'HIGH':
            await fast_lane_processor.process(message_data)
        else:
            await queue_manager.enqueue(message_data)

    async def monitor_chats(self, chat_ids: list):
        """–î–æ–±–∞–≤–∏—Ç—å —á–∞—Ç—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞"""
        self.monitored_chats = chat_ids
```

### 2. Priority Detector (–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤)

```python
# services/priority_detector.py
"""
–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ:
- –ö–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ (urgent, bug, error, –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
- –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (VIP –∫–ª–∏–µ–Ω—Ç—ã)
- –ö–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–æ—Ç–≤–µ—Ç –Ω–∞ –≤–∞–∂–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
- –í—Ä–µ–º–µ–Ω–∏ (–Ω–æ—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è = –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
"""

from typing import Literal
from datetime import datetime

Priority = Literal['HIGH', 'MEDIUM', 'LOW']

class PriorityDetector:
    """–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤"""

    URGENT_KEYWORDS = [
        'urgent', '—Å—Ä–æ—á–Ω–æ', 'bug', '–±–∞–≥', 'error', '–æ—à–∏–±–∫–∞',
        '–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç', '—Å–ª–æ–º–∞–ª–æ—Å—å', 'critical', '–∫—Ä–∏—Ç–∏—á–Ω–æ'
    ]

    VIP_USERS = [...]  # ID VIP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

    def determine_priority(self, message: dict) -> Priority:
        """–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è"""
        score = 0

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
        text_lower = message['text'].lower()
        if any(keyword in text_lower for keyword in self.URGENT_KEYWORDS):
            score += 50

        # VIP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        if message['user_id'] in self.VIP_USERS:
            score += 30

        # –ù–æ—á–Ω–æ–µ –≤—Ä–µ–º—è (22:00 - 08:00)
        hour = message['timestamp'].hour
        if hour < 8 or hour >= 22:
            score += 20

        # –û—Ç–≤–µ—Ç –Ω–∞ –≤–∞–∂–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if message['reply_to'] and self.is_important_thread(message['reply_to']):
            score += 25

        # –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è
        if score >= 50:
            return 'HIGH'
        elif score >= 25:
            return 'MEDIUM'
        else:
            return 'LOW'
```

### 3. Message Queue Manager

```python
# services/queue_manager.py
"""
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥—å—é —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Redis.
–ë–∞—Ç—á–∏–Ω–≥ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ API –∑–∞–ø—Ä–æ—Å–æ–≤.
"""

import redis
from typing import List
import json

class MessageQueue:
    """–û—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π"""

    def __init__(self, redis_url: str):
        self.redis = redis.from_url(redis_url)
        self.BATCH_SIZE = 50
        self.BATCH_TIMEOUT = 300  # 5 –º–∏–Ω—É—Ç

    async def enqueue(self, message: dict):
        """–î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥—å"""
        queue_key = f"messages:{message['chat_id']}"
        self.redis.rpush(queue_key, json.dumps(message))

    async def dequeue_batch(self, chat_id: int) -> List[dict]:
        """–ü–æ–ª—É—á–∏—Ç—å –±–∞—Ç—á —Å–æ–æ–±—â–µ–Ω–∏–π"""
        queue_key = f"messages:{chat_id}"
        messages = []

        for _ in range(self.BATCH_SIZE):
            msg = self.redis.lpop(queue_key)
            if not msg:
                break
            messages.append(json.loads(msg))

        return messages

    async def get_pending_count(self, chat_id: int) -> int:
        """–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
        return self.redis.llen(f"messages:{chat_id}")
```

### 4. Batch Processor (–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –±–∞—Ç—á–µ–π)

```python
# services/batch_processor.py
"""
–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±–∞—Ç—á–µ–π —Å–æ–æ–±—â–µ–Ω–∏–π.
Celery task, –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5-15 –º–∏–Ω—É—Ç.
"""

from celery import Celery
from typing import List

app = Celery('telegram_analyzer')

@app.task
async def process_message_batch(chat_id: int):
    """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –±–∞—Ç—á —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —á–∞—Ç–∞"""

    # –ü–æ–ª—É—á–∏—Ç—å –±–∞—Ç—á –∏–∑ –æ—á–µ—Ä–µ–¥–∏
    messages = await queue_manager.dequeue_batch(chat_id)

    if not messages:
        return

    # –ê–Ω–∞–ª–∏–∑ –±–∞—Ç—á–∞ —á–µ—Ä–µ–∑ Claude API
    analysis = await analyze_batch_with_claude(messages)

    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
    await db.save_messages(messages)
    await db.save_analysis(chat_id, analysis)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
    if analysis.requires_response:
        await assistant_bot.send_response(
            chat_id,
            analysis.suggested_response
        )

async def analyze_batch_with_claude(messages: List[dict]) -> dict:
    """–ê–Ω–∞–ª–∏–∑ –±–∞—Ç—á–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ Claude"""

    # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    context = format_messages_for_claude(messages)

    prompt = f"""
    –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–π –±–∞—Ç—á —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∏:

    {context}

    –û–ø—Ä–µ–¥–µ–ª–∏:
    1. –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã –∏ –ø—Ä–æ–±–ª–µ–º—ã
    2. –¢—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ —Å—Ä–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç
    3. –ü—Ä–µ–¥–ª–æ–∂–∏ –æ—Ç–≤–µ—Ç –µ—Å–ª–∏ –Ω—É–∂–µ–Ω
    4. Sentiment analysis
    """

    response = await claude_client.messages.create(
        model=CLAUDE_MODEL,
        max_tokens=4096,
        messages=[{"role": "user", "content": prompt}]
    )

    return parse_claude_response(response)
```

### 5. Database Models

```python
# models/database.py
"""
–ú–æ–¥–µ–ª–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL.
"""

from sqlalchemy import Column, Integer, String, DateTime, Text, Boolean, ForeignKey
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.dialects.postgresql import JSONB, UUID
import uuid

Base = declarative_base()

class Chat(Base):
    """–ß–∞—Ç—ã Telegram"""
    __tablename__ = 'chats'

    id = Column(Integer, primary_key=True)
    telegram_id = Column(String(50), unique=True, index=True)
    title = Column(String(255))
    chat_type = Column(String(50))  # group, supergroup, channel
    is_monitored = Column(Boolean, default=True)
    created_at = Column(DateTime)

class Message(Base):
    """–°–æ–æ–±—â–µ–Ω–∏—è (–∞–Ω–æ–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)"""
    __tablename__ = 'messages'

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    chat_id = Column(Integer, ForeignKey('chats.id'))
    telegram_message_id = Column(Integer)

    # –ê–Ω–æ–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    user_hash = Column(String(64))  # SHA256 —Ö—ç—à user_id
    text_content = Column(Text)  # –û—á–∏—â–µ–Ω –æ—Ç –ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

    timestamp = Column(DateTime, index=True)
    is_support = Column(Boolean, default=False)  # –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Ç–µ—Ö –ø–æ–¥–¥–µ—Ä–∂–∫–∏

    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    priority = Column(String(20))  # HIGH, MEDIUM, LOW
    processed = Column(Boolean, default=False)

class Analysis(Base):
    """–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞"""
    __tablename__ = 'analysis'

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    chat_id = Column(Integer, ForeignKey('chats.id'))
    batch_id = Column(String(50))  # ID –±–∞—Ç—á–∞ —Å–æ–æ–±—â–µ–Ω–∏–π

    # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
    summary = Column(Text)
    topics = Column(JSONB)  # JSON –º–∞—Å—Å–∏–≤ —Ç–µ–º
    sentiment = Column(String(20))  # positive, negative, neutral
    requires_response = Column(Boolean)
    suggested_response = Column(Text, nullable=True)

    analyzed_at = Column(DateTime)
    claude_model = Column(String(50))

class AssistantResponse(Base):
    """–û—Ç–≤–µ—Ç—ã AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞"""
    __tablename__ = 'assistant_responses'

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    chat_id = Column(Integer, ForeignKey('chats.id'))
    analysis_id = Column(UUID(as_uuid=True), ForeignKey('analysis.id'))

    response_text = Column(Text)
    sent_at = Column(DateTime)
    was_helpful = Column(Boolean, nullable=True)  # Feedback
```

---

## üîí –ê–ù–û–ù–ò–ú–ò–ó–ê–¶–ò–Ø –î–ê–ù–ù–´–•

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è –∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏–∏

```python
# services/anonymizer.py
"""
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
"""

import hashlib
import re
from typing import Dict

class DataAnonymizer:
    """–ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ç–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""

    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è
    PHONE_PATTERN = r'\+?\d{1,3}[-.\s]?\(?\d{1,4}\)?[-.\s]?\d{1,4}[-.\s]?\d{1,9}'
    EMAIL_PATTERN = r'\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b'
    NAME_PATTERN = r'\b[A-Z–ê-–Ø][a-z–∞-—è]+ [A-Z–ê-–Ø][a-z–∞-—è]+\b'

    def anonymize_message(self, message: Dict) -> Dict:
        """–ê–Ω–æ–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"""

        # –•—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ user_id
        message['user_hash'] = self.hash_user_id(message['user_id'])
        del message['user_id']  # –£–¥–∞–ª—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π ID

        # –û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞
        text = message['text']
        text = self.remove_phones(text)
        text = self.remove_emails(text)
        text = self.mask_names(text)
        message['text'] = text

        return message

    def hash_user_id(self, user_id: int) -> str:
        """–•—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ user_id (–Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ)"""
        return hashlib.sha256(str(user_id).encode()).hexdigest()

    def remove_phones(self, text: str) -> str:
        """–£–¥–∞–ª–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–æ–≤ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤"""
        return re.sub(self.PHONE_PATTERN, '[PHONE]', text)

    def remove_emails(self, text: str) -> str:
        """–£–¥–∞–ª–µ–Ω–∏–µ email –∞–¥—Ä–µ—Å–æ–≤"""
        return re.sub(self.EMAIL_PATTERN, '[EMAIL]', text)

    def mask_names(self, text: str) -> str:
        """–ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω"""
        return re.sub(self.NAME_PATTERN, '[NAME]', text)
```

### –£—Ä–æ–≤–Ω–∏ –∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏–∏

| –£—Ä–æ–≤–µ–Ω—å | –î–∞–Ω–Ω—ã–µ | –û–±—Ä–∞–±–æ—Ç–∫–∞ |
|---------|--------|-----------|
| **1. –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ** | User ID, Phone, Email | –£–¥–∞–ª—è—é—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞ |
| **2. –•—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** | User ID ‚Üí Hash | SHA256, –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ |
| **3. –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ** | –ò–º–µ–Ω–∞ ‚Üí [NAME] | –ó–∞–º–µ–Ω—è—é—Ç—Å—è —Ç–æ–∫–µ–Ω–æ–º |
| **4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ** | –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (–±–µ–∑ PII) | –•—Ä–∞–Ω–∏—Ç—Å—è –≤ –ë–î |

---

## üöÄ –ü–õ–ê–ù –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Ø –ùA DEBIAN VPS

### –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞

**–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- **CPU**: 2 cores
- **RAM**: 4GB
- **Storage**: 50GB SSD
- **Network**: 100 Mbps
- **OS**: Debian 12 (Bookworm)

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ (–¥–ª—è production):**
- **CPU**: 4 cores
- **RAM**: 8GB
- **Storage**: 100GB NVMe SSD
- **Network**: 1 Gbps
- **OS**: Debian 12 (Bookworm)

### –ü–æ—à–∞–≥–æ–≤–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

```bash
# ============================================================================
# –®–ê–ì 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
# ============================================================================

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
sudo apt update && sudo apt upgrade -y

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
sudo apt install -y \
    python3.12 python3.12-venv python3-pip \
    postgresql-16 postgresql-contrib \
    redis-server \
    nginx \
    git curl wget \
    supervisor \
    certbot python3-certbot-nginx

# ============================================================================
# –®–ê–ì 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL
# ============================================================================

# –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
sudo -u postgres psql <<EOF
CREATE DATABASE telegram_analyzer;
CREATE USER analyzer_user WITH PASSWORD 'strong_password_here';
GRANT ALL PRIVILEGES ON DATABASE telegram_analyzer TO analyzer_user;

-- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ pgvector –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE EXTENSION vector;
EOF

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
sudo nano /etc/postgresql/16/main/postgresql.conf
# –ò–∑–º–µ–Ω–∏—Ç—å:
# shared_buffers = 2GB
# effective_cache_size = 6GB
# maintenance_work_mem = 512MB
# checkpoint_completion_target = 0.9

sudo systemctl restart postgresql

# ============================================================================
# –®–ê–ì 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Redis
# ============================================================================

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Redis
sudo nano /etc/redis/redis.conf
# –ò–∑–º–µ–Ω–∏—Ç—å:
# maxmemory 1gb
# maxmemory-policy allkeys-lru

sudo systemctl restart redis-server

# ============================================================================
# –®–ê–ì 4: –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
# ============================================================================

# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
cd /opt
sudo git clone https://github.com/yourrepo/telegram_analyzer.git
cd telegram_analyzer

# –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
python3.12 -m venv venv
source venv/bin/activate

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip install -r requirements.txt
pip install -r requirements-prod.txt  # Production –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

# –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞
cat > .env <<EOF
# Telegram API
API_ID=your_api_id
API_HASH=your_api_hash
PHONE=+1234567890

# Claude API
CLAUDE_API_KEY=sk-ant-api03-...
CLAUDE_MODEL=claude-sonnet-4-20250514

# Database
DATABASE_URL=postgresql://analyzer_user:strong_password_here@localhost/telegram_analyzer

# Redis
REDIS_URL=redis://localhost:6379/0

# Security
SECRET_KEY=generate_random_secret_here
JWT_SECRET=generate_jwt_secret_here

# Monitoring
ENABLE_METRICS=true
PROMETHEUS_PORT=9090
EOF

# –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î
alembic upgrade head

# ============================================================================
# –®–ê–ì 5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Systemd —Å–µ—Ä–≤–∏—Å–æ–≤
# ============================================================================

# UserBot Service
sudo cat > /etc/systemd/system/telegram-userbot.service <<EOF
[Unit]
Description=Telegram UserBot Monitor
After=network.target postgresql.service redis.service

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/telegram_analyzer
Environment="PATH=/opt/telegram_analyzer/venv/bin"
ExecStart=/opt/telegram_analyzer/venv/bin/python -m services.userbot_monitor
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# Batch Processor (Celery Worker)
sudo cat > /etc/systemd/system/telegram-worker.service <<EOF
[Unit]
Description=Telegram Message Batch Processor
After=network.target redis.service

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/telegram_analyzer
Environment="PATH=/opt/telegram_analyzer/venv/bin"
ExecStart=/opt/telegram_analyzer/venv/bin/celery -A services.batch_processor worker --loglevel=info
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# Celery Beat (Scheduler)
sudo cat > /etc/systemd/system/telegram-beat.service <<EOF
[Unit]
Description=Telegram Batch Scheduler
After=network.target redis.service

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/telegram_analyzer
Environment="PATH=/opt/telegram_analyzer/venv/bin"
ExecStart=/opt/telegram_analyzer/venv/bin/celery -A services.batch_processor beat --loglevel=info
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# FastAPI Server
sudo cat > /etc/systemd/system/telegram-api.service <<EOF
[Unit]
Description=Telegram Analyzer API
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/telegram_analyzer
Environment="PATH=/opt/telegram_analyzer/venv/bin"
ExecStart=/opt/telegram_analyzer/venv/bin/uvicorn api.main:app --host 0.0.0.0 --port 8000 --workers 4
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# –í–∫–ª—é—á–µ–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
sudo systemctl daemon-reload
sudo systemctl enable telegram-userbot telegram-worker telegram-beat telegram-api
sudo systemctl start telegram-userbot telegram-worker telegram-beat telegram-api

# ============================================================================
# –®–ê–ì 6: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx
# ============================================================================

sudo cat > /etc/nginx/sites-available/telegram-analyzer <<'EOF'
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /ws {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
EOF

sudo ln -s /etc/nginx/sites-available/telegram-analyzer /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx

# –ü–æ–ª—É—á–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
sudo certbot --nginx -d your-domain.com

# ============================================================================
# –®–ê–ì 7: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
# ============================================================================

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Prometheus
cd /tmp
wget https://github.com/prometheus/prometheus/releases/download/v2.45.0/prometheus-2.45.0.linux-amd64.tar.gz
tar xvfz prometheus-*.tar.gz
sudo mv prometheus-2.45.0.linux-amd64 /opt/prometheus

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Prometheus
sudo cat > /opt/prometheus/prometheus.yml <<EOF
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'telegram-analyzer'
    static_configs:
      - targets: ['localhost:8000']
EOF

# Systemd service –¥–ª—è Prometheus
sudo cat > /etc/systemd/system/prometheus.service <<EOF
[Unit]
Description=Prometheus
After=network.target

[Service]
Type=simple
ExecStart=/opt/prometheus/prometheus --config.file=/opt/prometheus/prometheus.yml
Restart=always

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl enable prometheus
sudo systemctl start prometheus

# ============================================================================
# –®–ê–ì 8: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
# ============================================================================

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤
sudo cat > /etc/logrotate.d/telegram-analyzer <<EOF
/opt/telegram_analyzer/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    notifempty
    create 0640 www-data www-data
    sharedscripts
    postrotate
        systemctl reload telegram-userbot telegram-worker telegram-api
    endscript
}
EOF

# ============================================================================
# –®–ê–ì 9: Backup setup
# ============================================================================

# –°–∫—Ä–∏–ø—Ç –±—ç–∫–∞–ø–∞ –ë–î
sudo cat > /opt/telegram_analyzer/scripts/backup.sh <<'EOF'
#!/bin/bash
BACKUP_DIR="/var/backups/telegram_analyzer"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# Backup PostgreSQL
pg_dump -U analyzer_user telegram_analyzer | gzip > $BACKUP_DIR/db_$DATE.sql.gz

# Backup Redis
redis-cli --rdb $BACKUP_DIR/redis_$DATE.rdb

# –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)
find $BACKUP_DIR -type f -mtime +30 -delete
EOF

chmod +x /opt/telegram_analyzer/scripts/backup.sh

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ cron (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00 AM)
echo "0 3 * * * /opt/telegram_analyzer/scripts/backup.sh" | sudo crontab -

# ============================================================================
# –®–ê–ì 10: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
# ============================================================================

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
sudo systemctl status telegram-userbot telegram-worker telegram-beat telegram-api

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
sudo journalctl -u telegram-userbot -f

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
sudo -u postgres psql -d telegram_analyzer -c "SELECT version();"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Redis
redis-cli ping

# –ü—Ä–æ–≤–µ—Ä–∫–∞ API
curl http://localhost:8000/health

echo "–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
```

---

## üìà –ú–ê–°–®–¢–ê–ë–ò–†–û–í–ê–ù–ò–ï –ò –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø

### Horizontal Scaling

```yaml
# docker-compose.yml –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞
version: '3.8'

services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_DB: telegram_analyzer
      POSTGRES_USER: analyzer_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    deploy:
      replicas: 1

  redis:
    image: redis:7-alpine
    deploy:
      replicas: 1

  userbot:
    build: .
    command: python -m services.userbot_monitor
    depends_on:
      - postgres
      - redis
    deploy:
      replicas: 1  # –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω UserBot instance

  worker:
    build: .
    command: celery -A services.batch_processor worker
    depends_on:
      - redis
      - postgres
    deploy:
      replicas: 3  # –ù–µ—Å–∫–æ–ª—å–∫–æ –≤–æ—Ä–∫–µ—Ä–æ–≤ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

  api:
    build: .
    command: uvicorn api.main:app --host 0.0.0.0 --port 8000
    depends_on:
      - postgres
      - redis
    deploy:
      replicas: 2  # Load balancing
```

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

1. **Database Indexing**
```sql
-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE INDEX idx_messages_chat_timestamp ON messages(chat_id, timestamp DESC);
CREATE INDEX idx_messages_user_hash ON messages(user_hash);
CREATE INDEX idx_messages_priority ON messages(priority) WHERE processed = false;
CREATE INDEX idx_analysis_chat ON analysis(chat_id, analyzed_at DESC);
```

2. **Redis Caching**
```python
# –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
@cached(ttl=300)  # 5 –º–∏–Ω—É—Ç
async def get_chat_statistics(chat_id: int):
    return await db.query(...)
```

3. **Connection Pooling**
```python
# –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –¥–ª—è PostgreSQL
engine = create_async_engine(
    DATABASE_URL,
    pool_size=20,
    max_overflow=40,
    pool_pre_ping=True
)
```

---

## üîê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨

### –ß–µ–∫-–ª–∏—Å—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

- [ ] Firewall –Ω–∞—Å—Ç—Ä–æ–µ–Ω (UFW)
- [ ] SSH –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –ø–æ –∫–ª—é—á–∞–º
- [ ] Fail2ban —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- [ ] PostgreSQL –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞ –∏–∑–≤–Ω–µ
- [ ] Redis –∑–∞—â–∏—â–µ–Ω –ø–∞—Ä–æ–ª–µ–º
- [ ] .env —Ñ–∞–π–ª—ã –≤ .gitignore
- [ ] SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- [ ] Rate limiting –Ω–∞ API
- [ ] CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ
- [ ] –ë—ç–∫–∞–ø—ã –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω—ã

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Firewall

```bash
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UFW
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

# Fail2ban –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞
sudo apt install fail2ban
sudo systemctl enable fail2ban
```

---

## üìä –ú–û–ù–ò–¢–û–†–ò–ù–ì –ò OBSERVABILITY

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

1. **System Metrics**
   - CPU usage
   - Memory usage
   - Disk I/O
   - Network traffic

2. **Application Metrics**
   - Messages per second
   - Processing latency
   - Queue depth
   - Claude API calls per minute
   - Error rate

3. **Business Metrics**
   - Active chats
   - Response time (Fast Lane)
   - Batch processing time
   - Cost per message

### Grafana Dashboard

```json
{
  "dashboard": {
    "title": "Telegram Analyzer Monitoring",
    "panels": [
      {
        "title": "Messages Rate",
        "targets": [
          {
            "expr": "rate(messages_received_total[5m])"
          }
        ]
      },
      {
        "title": "Queue Depth",
        "targets": [
          {
            "expr": "redis_queue_length"
          }
        ]
      },
      {
        "title": "API Response Time",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(api_request_duration_seconds_bucket[5m]))"
          }
        ]
      }
    ]
  }
}
```

---

## üí∞ –û–¶–ï–ù–ö–ê –°–¢–û–ò–ú–û–°–¢–ò

### –ú–µ—Å—è—á–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã (–ø—Ä–∏ 1000 —Å–æ–æ–±—â–µ–Ω–∏–π/–¥–µ–Ω—å)

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–æ–∏–º–æ—Å—Ç—å |
|-----------|-----------|
| **VPS (4 cores, 8GB RAM)** | $40/–º–µ—Å |
| **Claude API (30k tokens/day)** | $150/–º–µ—Å |
| **Backup storage (50GB)** | $5/–º–µ—Å |
| **Domain + SSL** | $15/–≥–æ–¥ |
| **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Grafana Cloud)** | $0 (free tier) |
| **–ò–¢–û–ì–û** | ~$195/–º–µ—Å |

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —Ç–µ–∫—É—â–∏–º —Ä–µ—à–µ–Ω–∏–µ–º

| –ú–µ—Ç—Ä–∏–∫–∞ | –¢–µ–∫—É—â–µ–µ (v1.0) | –ù–æ–≤–æ–µ (v2.0) |
|---------|----------------|--------------|
| –ó–∞–¥–µ—Ä–∂–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ | 24+ —á–∞—Å–æ–≤ | 5-15 –º–∏–Ω—É—Ç |
| –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è | –†—É—á–Ω–∞—è | –ü–æ–ª–Ω–∞—è |
| –°—Ç–æ–∏–º–æ—Å—Ç—å | $0 (—Ä—É—á–Ω–æ–π —Ç—Ä—É–¥) | $195/–º–µ—Å |
| –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å | –ù–∏–∑–∫–∞—è | –í—ã—Å–æ–∫–∞—è |

---

## üéØ –ü–õ–ê–ù –†–ï–ê–õ–ò–ó–ê–¶–ò–ò (ROADMAP)

### –§–∞–∑–∞ 1: MVP (2-3 –Ω–µ–¥–µ–ª–∏)
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –±–∞–≥–æ–≤
- [ ] UserBot + –±–∞–∑–æ–≤—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- [ ] PostgreSQL —Å—Ö–µ–º–∞
- [ ] –ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- [ ] –ü—Ä–æ—Å—Ç–æ–π –±–∞—Ç—á –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä

### –§–∞–∑–∞ 2: Real-time + –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è (2 –Ω–µ–¥–µ–ª–∏)
- [ ] Fast Lane / Slow Lane
- [ ] Priority Detector
- [ ] Redis –æ—á–µ—Ä–µ–¥—å
- [ ] Celery –≤–æ—Ä–∫–µ—Ä—ã

### –§–∞–∑–∞ 3: AI Assistant Bot (2 –Ω–µ–¥–µ–ª–∏)
- [ ] LangChain –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- [ ] –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
- [ ] –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫
- [ ] Feedback loop

### –§–∞–∑–∞ 4: Production Hardening (1 –Ω–µ–¥–µ–ª—è)
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Prometheus + Grafana)
- [ ] –ê–ª–µ—Ä—Ç—ã
- [ ] –ë—ç–∫–∞–ø—ã
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –§–∞–∑–∞ 5: Advanced Features (ongoing)
- [ ] Web dashboard
- [ ] Analytics
- [ ] A/B testing –æ—Ç–≤–µ—Ç–æ–≤
- [ ] Multi-language support

---

## üìö –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –†–ï–°–£–†–°–´

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- Telethon: https://docs.telethon.dev/
- FastAPI: https://fastapi.tiangolo.com/
- Celery: https://docs.celeryproject.org/
- SQLAlchemy: https://docs.sqlalchemy.org/
- Claude API: https://docs.anthropic.com/

### Best Practices
- 12-Factor App: https://12factor.net/
- PostgreSQL Tuning: https://pgtune.leopard.in.ua/
- Redis Best Practices: https://redis.io/docs/management/optimization/

---

## ü§ù –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

–î–∞–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π **production-ready** —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è real-time –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞ Telegram —á–∞—Ç–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º AI.

**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
1. –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —á–∞—Ç—ã –∏ –≤–æ—Ä–∫–µ—Ä—ã
2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞—Ç—Ä–∞—Ç - –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ Fast/Slow Lane
3. –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å - fault tolerance —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥–∏ –∏ retry –º–µ—Ö–∞–Ω–∏–∑–º—ã
4. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å - –∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏ best practices
5. Observability - –ø–æ–ª–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –°–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å –∫–æ–º–∞–Ω–¥–æ–π
2. –ù–∞—á–∞—Ç—å —Å MVP (–§–∞–∑–∞ 1)
3. –ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
4. –°–æ–±–∏—Ä–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å

---

*–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: 2026-02-03*
*–í–µ—Ä—Å–∏—è: 2.0 DRAFT*
*–ê–≤—Ç–æ—Ä: Claude AI + Development Team*
